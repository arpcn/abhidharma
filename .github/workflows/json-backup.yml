name: JSON Backup

on:
  schedule:
    - cron: '0 */4 * * *'  # ÊØè4Â∞èÊó∂ËøêË°å
  workflow_dispatch:        # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë
  push:
    branches: [ main ]

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ÂÖ≥ÈîÆÔºöÊéà‰∫àÂÜôÊùÉÈôê
    
    steps:
      # 1. Ê£ÄÂá∫‰ª£Á†ÅÔºà‰ΩøÁî®tokenÔºâ
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      # 2. ÂÆâË£ÖÂ∑•ÂÖ∑
      - name: üîß Setup tools
        run: sudo apt-get update && sudo apt-get install -y jq curl
      
      # 3. ‰∏ãËΩΩJSON
      - name: üì• Download JSON
        run: |
          URL="https://publish-01.obsidian.md/cache/39a393bd37490e3597370f63f89358a6"
          mkdir -p mirror
          curl -s -L -o temp.json "$URL"
          
          # Ê£ÄÊü•‰∏ãËΩΩÊòØÂê¶ÊàêÂäü
          if [ ! -f "temp.json" ]; then
            echo "‚ùå Download failed"
            exit 1
          fi
      
      # 4. È™åËØÅJSON
      - name: ‚úÖ Validate JSON
        run: |
          if ! jq empty temp.json 2>/dev/null; then
            echo "‚ùå Invalid JSON format"
            echo "File preview:"
            head -c 200 temp.json
            exit 1
          fi
          
          echo "‚úÖ Valid JSON"
          echo "File size: $(wc -c < temp.json) bytes"
      
      # 5. Ê£ÄÊü•ÂèòÂåñÂπ∂Êõ¥Êñ∞
      - name: üîç Check and update
        run: |
          # Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®‰∏îÁõ∏Âêå
          if [ -f "mirror/abhidharma.json" ] && cmp -s temp.json mirror/abhidharma.json; then
            echo "üì≠ No changes detected"
            rm temp.json
            exit 0
          fi
          
          echo "üîÑ Changes detected, updating file..."
          mv temp.json mirror/abhidharma.json
      
      # 6. Êèê‰∫§Êõ¥ÊîπÔºà‰ΩøÁî®Ê≠£Á°ÆÁöÑÈÖçÁΩÆÔºâ
      - name: üîÑ Commit changes
        if: success()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add mirror/
          
          # Âè™ÊúâÂú®ÊúâÂèòÂåñÊó∂ÊâçÊèê‰∫§
          if ! git diff --staged --quiet; then
            git commit -m "üîÑ Update JSON backup $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push
            echo "‚úÖ Changes committed and pushed"
          else
            echo "üì≠ No changes to commit"
          fi
      
      # 7. ÂÆåÊàêÁä∂ÊÄÅ
      - name: ‚úÖ Done
        if: success()
        run: |
          echo "=== Backup Complete ==="
          echo "Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "File: mirror/abhidharma.json"
          if [ -f "mirror/abhidharma.json" ]; then
            echo "Size: $(wc -c < mirror/abhidharma.json) bytes"
          fi
