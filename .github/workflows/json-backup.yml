name: JSON Backup

on:
  schedule:
    # æ¯4å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 */4 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: ğŸ”§ Setup tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          echo "âœ… jq version: $(jq --version)"
        
      - name: ğŸ“¥ Download JSON
        run: |
          JSON_URL="https://publish-01.obsidian.md/cache/39a393bd37490e3597370f63f89358a6"
          JSON_FILE="mirror/abhidharma.json"
          TEMP_FILE="temp.json"
          
          echo "Downloading JSON from: $JSON_URL"
          
          mkdir -p mirror
          
          # ä¸‹è½½æ–‡ä»¶
          curl -s -L -o "$TEMP_FILE" "$JSON_URL"
          
          if [ ! -f "$TEMP_FILE" ]; then
            echo "âŒ Error: Download failed"
            exit 1
          fi
          
          FILESIZE=$(stat -f%z "$TEMP_FILE" 2>/dev/null || stat -c%s "$TEMP_FILE")
          if [ "$FILESIZE" -eq 0 ]; then
            echo "âŒ Error: File is empty"
            exit 1
          fi
          
          echo "âœ… Download successful"
          echo "ğŸ“ File size: $FILESIZE bytes"
        
      - name: âœ… Validate JSON
        run: |
          TEMP_FILE="temp.json"
          
          echo "Validating JSON format..."
          
          if ! jq empty "$TEMP_FILE" 2>/dev/null; then
            echo "âŒ Error: Invalid JSON format"
            echo "First 200 characters:"
            head -c 200 "$TEMP_FILE"
            exit 1
          fi
          
          JSON_TYPE=$(jq -r 'type' "$TEMP_FILE")
          echo "âœ… JSON validation passed"
          echo "ğŸ“Š Data type: $JSON_TYPE"
          
          if [ "$JSON_TYPE" = "array" ]; then
            COUNT=$(jq '. | length' "$TEMP_FILE")
            echo "ğŸ“ˆ Array length: $COUNT"
          elif [ "$JSON_TYPE" = "object" ]; then
            KEYS=$(jq '. | keys | length' "$TEMP_FILE")
            echo "ğŸ”‘ Object keys count: $KEYS"
          fi
        
      - name: ğŸ” Check for changes
        run: |
          TEMP_FILE="temp.json"
          JSON_FILE="mirror/abhidharma.json"
          
          if [ -f "$JSON_FILE" ]; then
            echo "Comparing with existing file..."
            
            # æ¯”è¾ƒJSONå†…å®¹ï¼ˆå¿½ç•¥æ ¼å¼å·®å¼‚ï¼‰
            if jq -c . "$TEMP_FILE" | cmp -s - <(jq -c . "$JSON_FILE"); then
              echo "ğŸ“ No changes detected"
              echo "Skipping update..."
              rm "$TEMP_FILE"
              exit 0
            else
              echo "ğŸ”„ Changes detected"
              
              # æ˜¾ç¤ºå·®å¼‚ï¼ˆå‰1000å­—ç¬¦ï¼‰
              echo "Differences preview:"
              jq -c . "$TEMP_FILE" | head -c 1000
              echo ""
            fi
          else
            echo "ğŸ“„ First backup, creating new file"
          fi
        
      - name: ğŸ’¾ Save JSON file
        run: |
          TEMP_FILE="temp.json"
          JSON_FILE="mirror/abhidharma.json"
          
          # æ ¼å¼åŒ–å¹¶ä¿å­˜
          jq . "$TEMP_FILE" > "$JSON_FILE"
          
          # æ·»åŠ å¤‡ä»½ä¿¡æ¯
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          jq --arg ts "$TIMESTAMP" \
             --arg url "https://publish-01.obsidian.md/cache/39a393bd37490e3597370f63f89358a6" \
             '. + {_backup_info: {last_updated: $ts, source_url: $url}}' \
             "$JSON_FILE" > "$JSON_FILE.tmp"
          
          mv "$JSON_FILE.tmp" "$JSON_FILE"
          
          FILESIZE=$(stat -f%z "$JSON_FILE" 2>/dev/null || stat -c%s "$JSON_FILE")
          echo "âœ… JSON file saved"
          echo "ğŸ“ File size: $FILESIZE bytes"
          echo "â° Backup time: $TIMESTAMP"
          
          rm "$TEMP_FILE"
        
      - name: ğŸ”„ Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add mirror/
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ No changes to commit"
          else
            git commit -m "ğŸ”„ Update JSON backup $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push
            echo "âœ… Changes committed"
          fi
        
      - name: ğŸ“Š Backup summary
        if: always()
        run: |
          echo "=== Backup Summary ==="
          echo "Status: ${{ job.status }}"
          echo "Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          
          if [ -f "mirror/abhidharma.json" ]; then
            echo "File: mirror/abhidharma.json"
            FILESIZE=$(stat -f%z "mirror/abhidharma.json" 2>/dev/null || stat -c%s "mirror/abhidharma.json")
            echo "Size: $FILESIZE bytes"
            
            # æ˜¾ç¤ºå¤‡ä»½ä¿¡æ¯
            if jq 'has("_backup_info")' "mirror/abhidharma.json" 2>/dev/null | grep -q true; then
              echo "Backup info:"
              jq '._backup_info' "mirror/abhidharma.json"
            fi
          else
            echo "âŒ Backup file not found"
          fi
