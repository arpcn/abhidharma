name: JSON Backup

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ï¼š0:00, 4:00, 8:00, 12:00, 16:00, 20:00
    - cron: '0 0,4,8,12,16,20 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    
    steps:
      # ç­‰å¾…ç­–ç•¥
      - name: â³ Delay to avoid Pages conflict
        run: |
          echo "Waiting 45 seconds to avoid GitHub Pages build conflict..."
          sleep 45
      
      # æ£€å‡ºä»£ç 
      - name: ðŸ“¥ Checkout main branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          fetch-depth: 0
      
      # ä¸‹è½½JSON
      - name: ðŸ“¥ Download and validate
        id: download
        run: |
          URL="https://publish-01.obsidian.md/cache/39a393bd37490e3597370f63f89358a6"
          mkdir -p mirror
          
          echo "Downloading from: $URL"
          curl -s -L -o temp.json "$URL"
          
          # åŸºæœ¬éªŒè¯
          SIZE=$(stat -c%s temp.json 2>/dev/null || wc -c < temp.json)
          echo "File size: $SIZE bytes"
          
          if [ "$SIZE" -lt 1000 ]; then
            echo "âŒ File too small, likely download failed"
            exit 1
          fi
          
          # å°è¯•JSONéªŒè¯ï¼ˆä¸å¼ºåˆ¶ï¼‰
          if jq . temp.json >/dev/null 2>&1; then
            echo "âœ… Valid JSON"
          else
            echo "âš ï¸ JSON parsing may have issues, but continuing"
          fi
          
          # æ¯”è¾ƒæ–‡ä»¶
          if [ -f "mirror/abhidharma.json" ] && cmp -s temp.json mirror/abhidharma.json; then
            echo "ðŸ“­ No changes"
            rm temp.json
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”„ Changes found"
            mv temp.json mirror/abhidharma.json
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      # æ™ºèƒ½æäº¤
      - name: ðŸ“¤ Smart commit and push
        if: steps.download.outputs.changed == 'true'
        run: |
          # é…ç½®Git
          git config user.name "Auto Backup"
          git config user.email "backup@example.com"
          
          # æ·»åŠ æ–‡ä»¶
          git add mirror/abhidharma.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®žé™…å˜åŒ–
          if git diff --cached --quiet; then
            echo "ðŸ“­ No actual changes to commit"
            exit 0
          fi
          
          # æäº¤
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S")
          git commit -m "ðŸ” Auto backup: $TIMESTAMP UTC"
          
          # å¸¦é‡è¯•çš„æŽ¨é€
          for i in {1..5}; do
            echo "ðŸ“¤ Pushing attempt $i/5..."
            
            if git push origin main; then
              echo "âœ… Successfully pushed"
              break
            else
              echo "âš ï¸ Push failed, retrying in 15 seconds..."
              sleep 15
              
              # æ‹‰å–æœ€æ–°æ›´æ”¹
              git pull --rebase origin main
              git add mirror/abhidharma.json
              git commit -m "ðŸ” Auto backup: $TIMESTAMP UTC (retry $i)"
            fi
          done
      
      # æœ€ç»ˆçŠ¶æ€
      - name: ðŸ“Š Final status
        run: |
          echo "=== Backup Status ==="
          echo "Time: $(date)"
          echo "Repository: ${{ github.repository }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Trigger: ${{ github.event_name }}"
          
          if [ -f "mirror/abhidharma.json" ]; then
            SIZE=$(stat -c%s mirror/abhidharma.json 2>/dev/null || wc -c < mirror/abhidharma.json)
            echo "Backup size: $SIZE bytes"
            echo "âœ… Backup completed successfully"
          else
            echo "â„¹ï¸ No backup created (no changes)"
          fi
