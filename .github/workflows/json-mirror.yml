name: JSON Mirror Backup

on:
  schedule:
    # æ¯4å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 */4 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

env:
  JSON_URL: 'https://publish-01.obsidian.md/cache/39a393bd37490e3597370f63f89358a6'
  MIRROR_FILE: 'mirror/abhidharma.json'

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“¥ ä¸‹è½½JSONæ–‡ä»¶
        run: |
          echo "å¼€å§‹ä¸‹è½½JSONæ–‡ä»¶..."
          
          # ä¸‹è½½JSONæ–‡ä»¶
          curl -s -L -o "temp.json" "${{ env.JSON_URL }}"
          
          # éªŒè¯JSONæ ¼å¼
          if ! jq empty temp.json 2>/dev/null; then
            echo "âŒ ä¸‹è½½çš„æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆJSON"
            cat temp.json | head -20
            exit 1
          fi
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          FILESIZE=$(stat -f%z "temp.json" 2>/dev/null || stat -c%s "temp.json")
          echo "âœ… JSONæ–‡ä»¶å¤§å°: ${FILESIZE} å­—èŠ‚"
          
      - name: ğŸ” æå–ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
        run: |
          echo "JSONæ–‡ä»¶ä¿¡æ¯ï¼š"
          echo "================"
          
          # æå–åŸºæœ¬ä¿¡æ¯
          TOTAL_ENTRIES=$(jq '. | length' temp.json 2>/dev/null || echo "æœªçŸ¥")
          echo "æ¡ç›®æ•°é‡: $TOTAL_ENTRIES"
          
          # å¦‚æœæœ‰timestampå­—æ®µ
          TIMESTAMP=$(jq -r '.[0].timestamp // .timestamp // "æœªçŸ¥"' temp.json 2>/dev/null)
          echo "æ—¶é—´æˆ³: $TIMESTAMP"
          
          # æŸ¥çœ‹å‰3ä¸ªæ¡ç›®çš„ç±»å‹
          echo "å‰3ä¸ªæ¡ç›®ç±»å‹:"
          jq '.[0:3] | map(type)' temp.json 2>/dev/null || echo "æ— æ³•è§£æ"
          
      - name: ğŸ¨ æ ¼å¼åŒ–JSON
        run: |
          # æ ¼å¼åŒ–JSONï¼ˆç¾åŒ–è¾“å‡ºï¼‰
          jq . temp.json > "formatted.json"
          
          # æ£€æŸ¥æ ¼å¼åŒ–åå¤§å°
          FORMATTED_SIZE=$(stat -f%z "formatted.json" 2>/dev/null || stat -c%s "formatted.json")
          echo "æ ¼å¼åŒ–åå¤§å°: ${FORMATTED_SIZE} å­—èŠ‚"
          
      - name: ğŸ“ åˆ›å»ºREADMEï¼ˆå¯é€‰ï¼‰
        run: |
          # åˆ›å»ºJSONçš„ç®€è¦è¯´æ˜
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          TOTAL_ENTRIES=$(jq '. | length' formatted.json 2>/dev/null || echo "æœªçŸ¥")
          
          cat > "mirror/README.md" << EOF
          # JSONé•œåƒæ–‡ä»¶è¯´æ˜
          
          æ­¤ç›®å½•åŒ…å«è‡ªåŠ¨æ›´æ–°çš„JSONé•œåƒæ–‡ä»¶ï¼š
          
          - **abhidharma.json** - Obsidian Abhidharmaçš„JSONæ•°æ®é•œåƒ
          - **abhidharma.min.json** - å‹ç¼©ç‰ˆæœ¬ï¼ˆç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰
          - **abhidharma.pretty.json** - æ ¼å¼åŒ–ç‰ˆæœ¬ï¼ˆä¾¿äºé˜…è¯»ï¼‰
          
          ## æ–‡ä»¶ä¿¡æ¯
          - æœ€åæ›´æ–°: $TIMESTAMP
          - æºåœ°å€: ${{ env.JSON_URL }}
          - æ€»æ¡ç›®æ•°: $TOTAL_ENTRIES
          - æ–‡ä»¶å¤§å°: $FORMATTED_SIZE å­—èŠ‚
          
          ## æ›´æ–°é¢‘ç‡
          - æ¯4å°æ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶æ›´æ–°
          - æ‰‹åŠ¨è§¦å‘ï¼šåœ¨GitHub Actionsé¡µé¢ç‚¹å‡»"Run workflow"
          
          ## ä½¿ç”¨ç¤ºä¾‹
          \`\`\`javascript
          // ç›´æ¥è¯»å–
          const data = require('./mirror/abhidharma.json');
          
          // æˆ–è€…ä½¿ç”¨fetch
          fetch('./mirror/abhidharma.json')
            .then(response => response.json())
            .then(data => console.log(data));
          \`\`\`
          
          ## éªŒè¯JSON
          \`\`\`bash
          # éªŒè¯JSONæ ¼å¼
          jq empty mirror/abhidharma.json
          
          # ç»Ÿè®¡æ¡ç›®æ•°
          jq '. | length' mirror/abhidharma.json
          \`\`\`
          EOF
          
      - name: ğŸ’¾ ä¿å­˜é•œåƒæ–‡ä»¶
        run: |
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p mirror
          
          # ä¿å­˜æ ¼å¼åŒ–ç‰ˆæœ¬
          mv formatted.json "${{ env.MIRROR_FILE }}"
          
          # åˆ›å»ºå‹ç¼©ç‰ˆæœ¬ï¼ˆæ²¡æœ‰å¤šä½™ç©ºæ ¼ï¼‰
          jq -c . "${{ env.MIRROR_FILE }}" > "mirror/abhidharma.min.json"
          
          # åˆ›å»ºä¾¿äºé˜…è¯»çš„ç‰ˆæœ¬
          cp "${{ env.MIRROR_FILE }}" "mirror/abhidharma.pretty.json"
          
          # æ·»åŠ å…ƒæ•°æ®ä¿¡æ¯
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "æœ€åæ›´æ–°æ—¶é—´: $TIMESTAMP"
          echo "é•œåƒæ–‡ä»¶å·²ä¿å­˜"
          
      - name: ğŸ”„ æäº¤æ›´æ”¹
        run: |
          git config --local user.email "json-mirror@github.com"
          git config --local user.name "JSON Mirror Bot"
          
          git add mirror/
          
          if git diff --staged --quiet; then
            echo "JSONæ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "ğŸ”„ æ›´æ–°JSONé•œåƒ $(date -u +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… JSONé•œåƒå·²æ›´æ–°"
          fi
          
      - name: ğŸ“Š è¿è¡Œç»Ÿè®¡
        if: always()
        run: |
          echo "å¤‡ä»½ä»»åŠ¡ç»Ÿè®¡ï¼š"
          echo "================"
          ls -lh mirror/
          echo ""
          echo "JSONéªŒè¯ï¼š"
          jq -n 'input | {entries: length, first_entry: .[0]?}' mirror/abhidharma.json
